name: Launch Tests

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout cÃ³digo fuente
      uses: actions/checkout@v2

    - name: Clonar el repositorio irisapitester
      run: git clone https://github.com/daniel-aguilar-garcia/irisapitester.git

    - name: Levantar Docker Compose
      run: docker-compose up -d
      working-directory: ./irisapitester

    - name: Wait for Docker
      run: sleep 30

    - name: Obtener valor de 'file'
      id: get_file_value
      run: |
        raw_file_value=$(curl -s http://localhost:52773/pull_run_and_file)
        echo "el valor de 'raw_file_value' es $raw_file_value"
        echo "raw_file_value=$raw_file_value" >> "$GITHUB_OUTPUT"

    - name: Mostrar valor de 'file'
      run: echo "el valor de 'raw_file_value' es ${{ steps.get_file_value.outputs.raw_file_value }}"

    - name: Enviar archivo a Google Chat
      run: |
        file_value="${{ steps.get_file_value.outputs.file_value }}"
        json_data="{
          \"cards\": [
            {
              \"header\": {
                \"title\": \"Execution Test Report\",
                \"imageUrl\": \"https://example.com/imagen.png\"
              },
              \"sections\": [
                {
                  \"widgets\": [
                    {
                      \"keyValue\": {
                        \"topLabel\": \"Press to open the report file\",
                        \"content\": \"<a href='http://localhost:52773/show_report/$file_value'>Abrir en el navegador</a>\",
                        \"onClick\": {
                          \"openLink\": {
                            \"url\": \"http://localhost:52773/show_report/$file_value\"
                          }
                        }
                      }
                    }
                  ]
                }
              ]
            }
          ]
        }"
        echo "file_value=$file_value" >> $GITHUB_OUTPUT
        curl -X POST -H "Content-Type: application/json" -d "$json_data" "${{ secrets.CHAT_WEBHOOK }}"
